<%
    nats_ips = link('nats').instances.map { |instance| instance.address }
    nats_port = link('nats').p("nats.port")
    nats_user = link('nats').p("nats.user")
    nats_password = link('nats').p("nats.password")

    nats_hosts = nats_ips.map do |h|
      "nats://#{nats_user}:#{nats_password}@#{h}:#{nats_port}"
    end

    nats_str = nats_hosts.join(",")
%>

processes:
- name: scrape-config-generator
  executable: /var/vcap/packages/scrape-config-generator/scrape-config-generator
  env:
    NATS_HOSTS: "<%= nats_str %>"
    SCRAPE_CONFIG_FILE_PATH: "<%= p('scrape_config_file_path') %>"
    CONFIG_EXPIRATION_INTERVAL: "<%= p('expiration_interval') %>"
    SCRAPE_CA_PATH: "/var/vcap/jobs/scrape-config-generator/config/certs/scrape_ca.crt"
    SCRAPE_CERT_PATH: "/var/vcap/jobs/scrape-config-generator/config/certs/scrape.crt"
    SCRAPE_KEY_PATH: "/var/vcap/jobs/scrape-config-generator/config/certs/scrape.key"
    CONFIG_TTL: "<%= p('config_ttl') %>"
    METRICS_PORT: "<%= p("metrics_port") %>"
  ephemeral_disk: true
