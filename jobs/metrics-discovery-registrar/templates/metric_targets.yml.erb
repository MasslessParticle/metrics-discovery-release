<%
scrape_configs = [{
  "job_name" => "metrics_discovery_registrar_#{spec.name}",
  "scheme" => "https",
  "dns_sd_configs" => [
    {
      "names" => ["q-s0.#{spec.name}.*.*.#{spec.dns_domain_name}"],
      "type" => "A",
      "port" => p('metrics.port'),
    },
  ],
  "relabel_configs" => [
    {
      "source_labels"=> ['__address__'], # always there (added by Prometheus)
      "target_label" => 'source_id',
      "replacement" => 'metrics_discovery_registrar'
    },
    {
      "source_labels"=> ['__address__'], # always there (added by Prometheus)
      "target_label" => 'origin',
      "replacement" => 'loggregator_metrics_discovery_registrar'
    }
  ],
  "tls_config" => {
    "server_name" => p('metrics.server_name'),
  }
}]
%>

<%= YAML.dump({"scrape_configs" => scrape_configs}) %>