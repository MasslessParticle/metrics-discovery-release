<%
    nats_ips = link('nats').instances.map { |instance| instance.address }
    nats_port = link('nats').p("nats.port")
    nats_user = link('nats').p("nats.user")
    nats_password = link('nats').p("nats.password")

    nats_hosts = nats_ips.map do |h|
      "nats://#{nats_user}:#{nats_password}@#{h}:#{nats_port}"
    end

    nats_str = nats_hosts.join(",")
%>

processes:
- name: metrics-discovery-registrar
  executable: /var/vcap/packages/metrics-discovery-registrar/discovery-registrar
  env:
    PUBLISH_INTERVAL: <%= p("publish_interval") %>
    NATS_HOSTS: "<%= nats_str %>"
    TARGETS_GLOB: <%= p("targets_glob") %>
    TARGET_REFRESH_INTERVAL: <%= p("target_refresh_interval") %>
    METRICS_PORT: "<%= p("metrics_port") %>"
  unsafe:
    unrestricted_volumes:
    - path: /var/vcap/jobs
      mount_only: true
    - path: /var/vcap/data/jobs
      mount_only: true
